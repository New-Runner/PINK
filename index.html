<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f9fafb;
      color: #2e2e2e;
      text-align: center;
      padding: 30px;
    }

    h2 {
      font-size: 24px;
      color: #333;
      margin-bottom: 20px;
    }

    .result {
      margin: 10px auto;
      padding: 10px 20px;
      border-radius: 12px;
      max-width: 90%;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: center;
    }

    .ok { background: #e6f7e6; color: #2e7d32; }
    .warn { background: #fff4e5; color: #e65100; }
    .fail { background: #fdecea; color: #c62828; }

    .icon {
      font-size: 20px;
    }

    #summary {
      margin-top: 20px;
      font-weight: 500;
    }

    .done {
      margin-top: 20px;
      font-weight: bold;
      color: #333;
    }

    .close-btn {
      margin-top: 20px;
      padding: 12px 24px;
      font-size: 16px;
      background-color: #3b82f6;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      display: none;
    }

    .ipinfo-box {
      font-size: 15px;
      margin-bottom: 20px;
      line-height: 1.5;
    }

    code {
      background: #eee;
      padding: 2px 4px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h2>üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...</h2>
  <div class="ipinfo-box" id="ipinfo"></div>
  <div class="result" id="ping"><span class="icon">‚è≥</span> –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –±–∞–Ω–∫–æ–º...</div>
  <div class="result" id="cf"><span class="icon">‚è≥</span> –ü—Ä–æ–≤–µ—Ä–∫–∞ Cloudflare...</div>
  <div class="result" id="egov"><span class="icon">‚è≥</span> –ü—Ä–æ–≤–µ—Ä–∫–∞ egov.kz...</div>
  <div class="done" id="doneMsg" style="display:none;">‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞</div>
  <div id="summary"></div>
  <button class="close-btn" id="closeBtn" onclick="Telegram.WebApp.close()">–ó–∞–∫—Ä—ã—Ç—å</button>

  <script>
    let resultData = { ping: null, egov: null, cf: null };
    let completedChecks = 0;

    function ratePing(ms) {
      if (ms <= 100) return { icon: "üü¢", label: "–æ—Ç–ª–∏—á–Ω–æ", cls: "ok" };
      if (ms <= 300) return { icon: "üü†", label: "—Å—Ä–µ–¥–Ω–µ", cls: "warn" };
      return { icon: "üî¥", label: "–ø–ª–æ—Ö–æ", cls: "fail" };
    }

    function checkAllDone() {
      if (++completedChecks >= 3) {
        document.getElementById("doneMsg").style.display = "block";
        document.getElementById("closeBtn").style.display = "inline-block";
        showSummary();
      }
    }

    function showSummary() {
      const { ping, egov, cf } = resultData;
      const summary = document.getElementById("summary");

      if (!cf || cf.fail) {
        summary.innerHTML = "‚ùå Cloudflare –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±–∞–Ω–∫–∞ –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å.";
        summary.className = "fail";
        return;
      }

      if (ping && egov && ping.ms && egov.ms && ping.ms > egov.ms * 2) {
        summary.innerHTML = "‚ö†Ô∏è –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–Ω–∫–æ–º –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —Ö—É–∂–µ, —á–µ–º —Å –¥—Ä—É–≥–∏–º–∏ —Å–∞–π—Ç–∞–º–∏. –í–æ–∑–º–æ–∂–Ω–æ, –±–∞–Ω–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ –≤–∞—à–µ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞.";
        summary.className = "warn";
        return;
      }

      if (ping.ms > 300 || egov.ms > 300 || cf.ms > 300) {
        summary.innerHTML = "‚ö†Ô∏è –í—ã—Å–æ–∫–∏–π –ø–∏–Ω–≥ ‚Äî –≤–æ–∑–º–æ–∂–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –±–∞–Ω–∫–∞.";
        summary.className = "warn";
        return;
      }

      summary.innerHTML = "‚úÖ –í–∞—à–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –æ—Ç–ª–∏—á–Ω–æ–µ. –í—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ.";
      summary.className = "ok";
    }

    async function sendData() {
      const ipinfo = document.getElementById("ipinfo");
      try {
        const ipData = await fetch("https://ipapi.co/json/").then(r => r.json());
        const ua = navigator.userAgent;
        ipinfo.innerHTML = `
          <strong>–í–∞—à IP:</strong> ${ipData.ip}<br>
          <strong>–ì–æ—Ä–æ–¥:</strong> ${ipData.city}, ${ipData.country_name}<br>
          <strong>–ü—Ä–æ–≤–∞–π–¥–µ—Ä:</strong> ${ipData.org}
        `;

        Telegram.WebApp.sendData(JSON.stringify({
          ip: ipData.ip, city: ipData.city, country: ipData.country_name, org: ipData.org, ua
        }));
      } catch (e) {
        ipinfo.innerText = "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å IP-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.";
      }

      // Ping to Freedom Bank
      const startBank = performance.now();
      fetch("https://bankffin.kz", { mode: "no-cors" })
        .then(() => {
          const ms = Math.round(performance.now() - startBank);
          const rating = ratePing(ms);
          resultData.ping = { ms, fail: false };
          document.getElementById("ping").innerHTML = `<span class="icon">${rating.icon}</span> –°–≤—è–∑—å —Å –±–∞–Ω–∫–æ–º –§—Ä–∏–¥–æ–º –ë–∞–Ω–∫ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω: ${ms} –º—Å (${rating.label})`;
          document.getElementById("ping").className = `result ${rating.cls}`;
        })
        .catch(() => {
          resultData.ping = { fail: true };
          document.getElementById("ping").innerHTML = `<span class="icon">üî¥</span> –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å –±–∞–Ω–∫–æ–º –§—Ä–∏–¥–æ–º –ë–∞–Ω–∫ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω`;
          document.getElementById("ping").className = "result fail";
        })
        .finally(checkAllDone);

      // Ping to Cloudflare
      const startCF = performance.now();
      fetch("https://www.cloudflare.com/cdn-cgi/trace", { mode: "no-cors" })
        .then(() => {
          const ms = Math.round(performance.now() - startCF);
          const rating = ratePing(ms);
          resultData.cf = { ms, fail: false };
          document.getElementById("cf").innerHTML = `<span class="icon">${rating.icon}</span> –°–µ—Ä–≤–∏—Å Cloudflare –¥–æ—Å—Ç—É–ø–µ–Ω: ${ms} –º—Å (${rating.label})`;
          document.getElementById("cf").className = `result ${rating.cls}`;
        })
        .catch(() => {
          resultData.cf = { fail: true };
          document.getElementById("cf").innerHTML = `<span class="icon">üî¥</span> –°–µ—Ä–≤–∏—Å Cloudflare –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω`;
          document.getElementById("cf").className = "result fail";
        })
        .finally(checkAllDone);

      // Ping to egov.kz
      const startEgov = performance.now();
      fetch("https://egov.kz", { mode: "no-cors" })
        .then(() => {
          const ms = Math.round(performance.now() - startEgov);
          const rating = ratePing(ms);
          resultData.egov = { ms, fail: false };
          document.getElementById("egov").innerHTML = `<span class="icon">${rating.icon}</span> –°–≤—è–∑—å —Å –ø–æ—Ä—Ç–∞–ª–æ–º egov.kz: ${ms} –º—Å (${rating.label})`;
          document.getElementById("egov").className = `result ${rating.cls}`;
        })
        .catch(() => {
          resultData.egov = { fail: true };
          document.getElementById("egov").innerHTML = `<span class="icon">üî¥</span> –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å –ø–æ—Ä—Ç–∞–ª–æ–º egov.kz`;
          document.getElementById("egov").className = "result fail";
        })
        .finally(checkAllDone);
    }

    window.addEventListener('DOMContentLoaded', () => setTimeout(sendData, 500));
  </script>
</body>
</html>
